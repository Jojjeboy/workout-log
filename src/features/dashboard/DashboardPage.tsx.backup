import { Container, Grid, Card, Text, Title, Loader, Center, Stack, Group, ThemeIcon, Badge, ActionIcon, Paper, Box } from '@mantine/core';
import { IconTrendingUp, IconActivity, IconCalendar, IconArrowUpRight, IconArrowDownRight } from '@tabler/icons-react';
import { useWorkouts } from '../../hooks/useWorkouts';
import { useAuth } from '../../hooks/useAuth';
import { ThemeToggle } from '../../components/ThemeToggle';
import './DashboardPage.css';

export function DashboardPage() {
    const { logs, isLoading } = useWorkouts();
    const { user } = useAuth();

    const stats = {
        totalWorkouts: logs?.length || 0,
        totalExercises: logs ? new Set(logs.map(l => l.exerciseId)).size : 0,
        totalSets: logs?.reduce((acc, log) => acc + (log.sets?.length || 0), 0) || 0,
        thisWeek: logs?.filter(log => {
            const now = Date.now();
            const week = 7 * 24 * 60 * 60 * 1000;
            return log.timestamp > now - week;
        }).length || 0,
    };

    if (isLoading) {
        return <Center style={{ height: 400 }}><Loader /></Center>;
    }

    return (
        <Box bg="var(--mantine-color-body)" style={{ minHeight: '100vh', paddingBottom: '100px' }}>
            {/* Header Section */}
            <div style={{
                background: 'linear-gradient(135deg, #6a11cb 0%, #2575fc 100%)',
                padding: '40px 20px 80px',
                color: 'white',
                borderBottomLeftRadius: '30px',
                borderBottomRightRadius: '30px',
                marginBottom: '-60px'
            }}>
                <Group justify="space-between" align="flex-start" mb="xl">
                    <div>
                        <Text size="sm" style={{ opacity: 0.8 }}>Welcome back</Text>
                        <Title order={1} style={{ fontSize: '28px' }}>{user?.displayName || 'Athlete'}</Title>
                    </div>
                    <ThemeToggle />
                </Group>
            </div>

            <Container size="lg" px="md">
                <Stack gap="xl">
                    {/* Stats Grid */}
                    <Grid gutter="md">
                        <Grid.Col span={6}>
                            <Card padding="lg" radius="xl">
                                <Group justify="space-between" align="flex-start" mb="sm">
                                    <ThemeIcon size={40} radius="xl" color="green" variant="light">
                                        <IconActivity size={20} />
                                    </ThemeIcon>
                                    <Badge color="green" variant="light" size="sm" leftSection={<IconArrowUpRight size={12} />}>
                                        +12%
                                    </Badge>
                                </Group>
                                <Text size="xs" c="dimmed" fw={500}>Total Volume</Text>
                                <Text size="xl" fw={700}>{stats.totalSets}</Text>
                            </Card>
                        </Grid.Col>
                        <Grid.Col span={6}>
                            <Card padding="lg" radius="xl">
                                <Group justify="space-between" align="flex-start" mb="sm">
                                    <ThemeIcon size={40} radius="xl" color="red" variant="light">
                                        <IconTrendingUp size={20} />
                                    </ThemeIcon>
                                    <Badge color="red" variant="light" size="sm" leftSection={<IconArrowDownRight size={12} />}>
                                        -2%
                                    </Badge>
                                </Group>
                                <Text size="xs" c="dimmed" fw={500}>Workouts</Text>
                                <Text size="xl" fw={700}>{stats.totalWorkouts}</Text>
                            </Card>
                        </Grid.Col>
                        <Grid.Col span={6}>
                            <Card padding="lg" radius="xl">
                                <Group justify="space-between" align="flex-start" mb="sm">
                                    <ThemeIcon size={40} radius="xl" color="blue" variant="light">
                                        <IconCalendar size={20} />
                                    </ThemeIcon>
                                    <Badge color="blue" variant="light" size="sm" leftSection={<IconArrowUpRight size={12} />}>
                                        +5%
                                    </Badge>
                                </Group>
                                <Text size="xs" c="dimmed" fw={500}>Active Days</Text>
                                <Text size="xl" fw={700}>{stats.thisWeek}</Text>
                            </Card>
                        </Grid.Col>
                        <Grid.Col span={6}>
                            <Card padding="lg" radius="xl">
                                <Group justify="space-between" align="flex-start" mb="sm">
                                    <ThemeIcon size={40} radius="xl" color="orange" variant="light">
                                        <IconActivity size={20} />
                                    </ThemeIcon>
                                    <Badge color="green" variant="light" size="sm" leftSection={<IconArrowUpRight size={12} />}>
                                        +8%
                                    </Badge>
                                </Group>
                                <Text size="xs" c="dimmed" fw={500}>Exercises</Text>
                                <Text size="xl" fw={700}>{stats.totalExercises}</Text>
                            </Card>
                        </Grid.Col>
                    </Grid>

                    {/* Weekly Activity */}
                    <Card padding="lg" radius="xl">
                        <Group justify="space-between" mb="lg">
                            <Title order={4}>Weekly Activity</Title>
                            <Badge variant="light" color="gray">This Week</Badge>
                        </Group>
                        <div style={{ height: '150px', display: 'flex', alignItems: 'flex-end', justifyContent: 'space-between', paddingBottom: '10px' }}>
                            {[40, 70, 30, 85, 50, 65, 90].map((h, i) => (
                                <div key={i} style={{ width: '10%', height: '100%', display: 'flex', flexDirection: 'column', justifyContent: 'flex-end', alignItems: 'center', gap: '8px' }}>
                                    <div style={{ width: '100%', height: `${h}%`, background: i === 6 ? '#2575fc' : '#e9ecef', borderRadius: '8px' }} />
                                    <Text size="xs" c="dimmed">{['S', 'M', 'T', 'W', 'T', 'F', 'S'][i]}</Text>
                                </div>
                            ))}
                        </div>
                    </Card>

                    {/* Recent Activity List */}
                    <div>
                        <Group justify="space-between" mb="md">
                            <Title order={4}>Recent Workouts</Title>
                            <Text size="sm" c="blue" style={{ cursor: 'pointer' }}>View All</Text>
                        </Group>
                        <Stack gap="md">
                            {logs?.slice(0, 3).map((log, index) => (
                                <Paper key={index} p="md" radius="xl" withBorder={false} style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                                    <Group>
                                        <ThemeIcon size={40} radius="xl" color={index % 2 === 0 ? 'green' : 'red'} variant="light">
                                            {index % 2 === 0 ? <IconArrowDownRight size={20} /> : <IconArrowUpRight size={20} />}
                                        </ThemeIcon>
                                        <div>
                                            <Text fw={600} size="sm">Workout Session</Text>
                                            <Text size="xs" c="dimmed">{new Date(log.timestamp).toLocaleDateString()}</Text>
                                        </div>
                                    </Group>
                                    <div style={{ textAlign: 'right' }}>
                                        <Text fw={600} size="sm" c={index % 2 === 0 ? 'green' : 'red'}>
                                            {log.sets?.length || 0} Sets
                                        </Text>
                                        <Text size="xs" c="dimmed">Completed</Text>
                                    </div>
                                </Paper>
                            ))}
                        </Stack>
                    </div>
                </Stack>
            </Container>
        </Box>
    );
}
